---
title: "Geographical Distribution of Select Sexual Crimes"
author: "Amin Yakubu"
date: "11/26/2018"
output:
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```


Loading the required libraries

```{r}
library(tidyverse)
library(htmltools)
library(htmlwidgets)
library(leaflet)
library(leaflet.extras)
library(revgeo)


library(rgdal)
if (!require(geojsonio)) {
    install.packages("geojsonio")
    library(geojsonio)
}
library(sp)
library(maps)
library(ggmap)
library(maptools)
```

Reading in the datasets

```{r}
crimes_df = readRDS(file = "./datasets/all_sex_drug_weapon_zip_2017.rds")
```

```{r}

crimes_df = crimes_df %>% 
  mutate(zipcode = as.numeric(str_extract(zip, "[0-9][0-9][0-9][0-9][0-9]"))) %>% 
  summarize_all(funs(sum(is.na(.))))

crimes_df %>% filter(is.na(zipcode))

crimes_df %>% 

zip_df_1 = readRDS(file = "./datasets/nyc_rape_zip.rds")

zip_df_2 = readRDS(file = "./datasets/nyc_rape_zip_2.rds")

all_zip_df = bind_rows(zip_df_1, zip_df_2) 

all_zip_df = all_zip_df %>% mutate(zip = as.character(zip)) %>% 
  mutate(zip = str_replace(zip, "list\\(zip =", ""),
         zip = str_replace(zip, "\\)", ""),
         zipcode = gsub('"', '', zip),
         zipcode = str_replace(zipcode, ":[0-9][0-9][0-9][0-9][0-9]", ""),
         zipcode = str_replace(zipcode, "-[0-9][0-9][0-9][0-9]", ""),
         zipcode = as.numeric(zipcode),
         zipcode = as.factor(zipcode))

all_zip_df  %>%
  summarize_all(funs(sum(is.na(.))))

group_zip = all_zip_df %>% group_by(zipcode) %>% summarize(number = n())

map_url = "http://data.beta.nyc//dataset/3bf5fb73-edb5-4b05-bb29-7c95f4a727fc/resource/6df127b1-6d04-4bb7-b983-07402a2c3f90/download/f4129d9aa6dd4281bc98d0f701629b76nyczipcodetabulationareas.geojson"

download.file(map_url, "./datasets/nyc_zip_map.geojson")

```

```{r}
map_json <- geojson_read("./datasets/nyc_zip_map.geojson", what = "sp")

```

```{r}
map_json@data = 
  map_json@data %>% 
  left_join(group_zip, by = c("postalCode" = "zipcode")) %>% mutate(number = as.numeric(number)) %>% 
  mutate(number = if_else(is.na(number), 0, number))

```

Now let's plot our polygons

#### Distribution of reported rape and attempted rape in 2017 

```{r}

library(sp)
library(tmap)

# Use qtm() to create a choropleth map of gdp
qtm(shp = map_json, fill = "number")

# create color palette with colorNumeric()
nyc_pal <- colorNumeric("Reds", domain = NULL)

map_json %>% 
  leaflet() %>% 
  #addTiles() %>% 
  #addProviderTiles("OpenStreetMap.BlackAndWhite")%>% 
  setView(lat = 40.7, lng = -74.0, zoom = 11) %>% 
  addPolygons(weight = 2, group = "zipcode",
              color = nyc_pal(map_json@data$number), 
              fillOpacity = 0.5, opacity = 5, 
              smoothFactor = 0.2, 
  # add labels that display mumber
              label = ~ paste(postalCode, borough, ':', number, sep = '\n'),
              # highlight polygons on hover
              highlight = highlightOptions(weight = 2, color = "black",
              bringToFront = TRUE)) %>% 
  addSearchFeatures(options = searchFeaturesOptions(zoom = 12), targetGroups = "zipcode") %>% 
   addLegend(pal = nyc_pal,
                   values = c(0:50),
                   opacity = 0.75,
                   title = "Number of reported rape",
                   position = "topleft") %>% addControl("Distrition of reported rape and attempted race cases by Zip codes", position = "topright")

```

#### Distribution of sexual related crimes in NYC

```{r}

sex_related = filter(sex_drug_weapons, crime_group == "Sex-Related") %>% 
  filter(!is.na(longitude) | !is.na(latitude))

drug_related = filter(sex_drug_weapons, crime_group == "Drug-Related") %>% 
  filter(!is.na(longitude) | !is.na(latitude))

weapon_related = filter(sex_drug_weapons, crime_group == "Weapon-Related") %>% 
  filter(!is.na(longitude) | !is.na(latitude))

pal <- 
   colorFactor(palette = c("blue", "red", "green"), 
               levels = c("Sex-Related", "Weapon-Related", "Drug-Related"))

m1 <- leaflet()  %>% 
  addTiles() %>% 
#Setting view on NYC. The values are the coordinates of NYC
    setView(lat = 40.7, lng = -74.0, zoom = 11) %>% 
  addCircleMarkers(data = sex_related,
                   lng = ~ longitude,
                   lat = ~ latitude, 
                   radius = 1,
                   color = ~pal(crime_group),
                   group = "Sex-Related") %>% 
  addCircleMarkers(data = drug_related,
                   lng = ~ longitude,
                   lat = ~ latitude, 
                   radius = 1,
                   color = ~pal(crime_group),
                   group = "Drug-Related") %>% 
  addCircleMarkers(data = weapon_related,
                   lng = ~ longitude,
                   lat = ~ latitude, 
                   radius = 1,
                   color = ~pal(crime_group),
                   group = "Weapon-Related") 

```

Adding years 

```{r}
year_2014 = filter(sex_drug_weapons, year == 2014) %>% 
  filter(!is.na(longitude) | !is.na(latitude))

year_2015 = filter(sex_drug_weapons, year == 2015) %>% 
  filter(!is.na(longitude) | !is.na(latitude))

year_2016 = filter(sex_drug_weapons, year == 2016) %>% 
  filter(!is.na(longitude) | !is.na(latitude))

year_2017 =filter(sex_drug_weapons, year == 2017) %>% 
  filter(!is.na(longitude) | !is.na(latitude))

leaflet()  %>% 
  addTiles() %>% 
#Setting view on NYC. The values are the coordinates of NYC
    setView(lat = 40.7, lng = -74.0, zoom = 11) %>%
  addCircleMarkers(data = year_2014,
                   lng = ~ longitude,
                   lat = ~ latitude, 
                   radius = 1,
                   color = ~pal(crime_group),
                   group = "2014") %>% 
  addCircleMarkers(data = year_2015,
                   lng = ~ longitude,
                   lat = ~ latitude, 
                   radius = 1,
                   color = ~pal(crime_group),
                   group = "2015") %>% 
  addCircleMarkers(data = year_2016,
                   lng = ~ longitude,
                   lat = ~ latitude, 
                   radius = 1,
                   color = ~pal(crime_group),
                   group = "2016") %>% 
  addCircleMarkers(data = year_2017,
                   lng = ~ longitude,
                   lat = ~ latitude, 
                   radius = 1,
                   color = ~pal(crime_group),
                   group = "2017") %>%
  addLayersControl(overlayGroups = c("2014", "2015", "2016", "2017")) %>% 
   addLegend(pal = pal, 
            values = c("Sex-Related", "Weapon-Related", "Drug-Related"),
            opacity = .5,
            title = "Crime Group",
            position = "topleft")
```

```{r}
if(!requireNamespace("devtools")) install.packages("devtools")
devtools::install_github("dkahle/ggmap", ref = "tidyup")
ggmap(get_googlemap())
register_google(key = "AIzaSyDw5EnVgVgN0M-_0G67bieKEGS0KVEvgNE")

nyc = c(lon = -74.0059, lat = 40.7128)

nyc_map = get_map(location = nyc, zoom = 10, api_key = "AIzaSyDw5EnVgVgN0M-_0G67bieKEGS0KVEvgNE")

ggmap(nyc_map)
ggplot(data = sex_drug_weapons, aes(longitude, latitude, color = crime_group)) + geom_point(aes(alpha = .4))
```


