---
title: "seasonality"
author: "Amin Yakubu"
date: "11/27/2018"
output:
  html_document:
    toc: true
    toc_float: true
---

```{r seasonality_setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(eval = FALSE)
```

```{r seasonality_libraries}
library(tidyverse)
library(lubridate)
library(patchwork)
library(chron)
library(rvest)
```

Loading the dataset
```{r seasonality_data}
sex_drug_weapons = readRDS(file = "./datasets/sex_drug_weapons.rds") 
```

#### Season trends

```{r seasonality_trend}
season_df = sex_drug_weapons %>% 
  mutate(quarter = as.numeric(quarter(cmplnt_fr_dt)),
         month = months(cmplnt_fr_dt),
         month = forcats::fct_relevel(month, c("January", "February", "March", "April", "May", "June", "July",
                                               "August", "September", "October", "November", "December")),
         day = weekdays(cmplnt_fr_dt),
         day = forcats::fct_relevel(day, c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday")),
         cmplnt_fr_tm = lubridate::hms(as.character(cmplnt_fr_tm)),
         hour = hour(cmplnt_fr_tm)) %>% select(-cmplnt_fr_tm)


season_df %>% 
  group_by(boro_nm, quarter, crime_group) %>% 
  filter(!is.na(boro_nm)) %>% 
  summarize(number = n()) %>% 
  ggplot(aes(x = boro_nm, y = number, fill = as.factor(quarter))) + 
  geom_bar(stat = "identity")

season_df %>% 
  group_by(boro_nm, quarter, crime_group) %>% 
  filter(!is.na(boro_nm)) %>% 
  summarize(number = n()) %>% 
  ggplot(aes(x = boro_nm, y = number, fill = as.factor(quarter))) + 
  geom_bar(stat = "identity") + facet_wrap(~ crime_group)

season_df %>% 
  group_by(boro_nm, year, month) %>% 
  filter(!is.na(boro_nm)) %>% 
  summarize(number = n()) %>% 
  ggplot(aes(x = month, y = number, color = boro_nm, group = boro_nm)) + 
  geom_line()  + facet_wrap(~ year) +
  theme(axis.text.x = element_text(angle = 80, hjust = 1, size = 8)) + theme(legend.position = "none")

year4 = season_df %>% filter(year == 2014) %>% 
  group_by(boro_nm, month, crime_group) %>% 
  filter(!is.na(boro_nm)) %>% 
  summarize(number = n()) %>% 
  ggplot(aes(x = month, y = number, color = boro_nm, group = boro_nm)) + 
  geom_line()  + facet_wrap(~ crime_group) +
  theme(axis.text.x = element_text(angle = 80, hjust = 1, size = 8)) + theme(legend.position = "none")

year5 = season_df %>% filter(year == 2015) %>% 
  group_by(boro_nm, month, crime_group) %>% 
  filter(!is.na(boro_nm)) %>% 
  summarize(number = n()) %>% 
  ggplot(aes(x = month, y = number, color = boro_nm, group = boro_nm)) + 
  geom_line()  + facet_wrap(~ crime_group) +
  theme(axis.text.x = element_text(angle = 80, hjust = 1, size = 8)) + theme(legend.position = "none")

year6 = season_df %>% filter(year == 2016) %>% 
  group_by(boro_nm, month, crime_group) %>% 
  filter(!is.na(boro_nm)) %>% 
  summarize(number = n()) %>% 
  ggplot(aes(x = month, y = number, color = boro_nm, group = boro_nm)) + 
  geom_line()  + facet_wrap(~ crime_group) +
  theme(axis.text.x = element_text(angle = 80, hjust = 1, size = 8)) + theme(legend.position = "none")

year7 = season_df %>% filter(year == 2017) %>% 
  group_by(boro_nm, month, crime_group) %>% 
  filter(!is.na(boro_nm)) %>% 
  summarize(number = n()) %>% 
  ggplot(aes(x = month, y = number, color = boro_nm, group = boro_nm)) + 
  geom_line()  + facet_wrap(~ crime_group) +
  theme(axis.text.x = element_text(angle = 80, hjust = 1, size = 8)) + theme(legend.position = "bottom")

(year4 + year5) / (year6 + year7)
```

#### Time 

```{r seasonality_time}
 
season_df %>% 
  group_by(boro_nm, hour) %>% 
  summarize(number = n()) %>% 
  ggplot(aes(x = as.factor(hour), y = number, fill = boro_nm)) + geom_col()+ facet_wrap(~boro_nm)
  
```

```{r seasonality_plot_sex}
season_df %>% 
  group_by(day, hour) %>% filter(crime_group == "Sex-Related") %>% 
  summarize(number = n()) %>% 
  ggplot(aes(x = as.factor(hour), y = day)) +
  geom_tile(aes(fill = number), colour = "white") +
  scale_fill_gradient(low = "#fde0dd", high = "#c51b8a") +
  labs(
    title = "Day of the Week on Sex-Related crime activity",
    x = "Hour of day",
    y = "Day of the Week"
  ) + theme_classic() +
  theme(plot.subtitle = element_text(hjust = 0.5))
```

```{r seasonality_plot_drug}
season_df %>% filter(crime_group == "Drug-Related") %>% 
  group_by(day, hour) %>% 
  summarize(number = n()) %>% 
  ggplot(aes(x = as.factor(hour), y = day)) +
  geom_tile(aes(fill = number), colour = "white") +
  scale_fill_gradient(low = "#fde0dd", high = "#c51b8a") +
  labs(
    title = "Day of the Week on Drug-Related crime activity",
    x = "Hour of day",
    y = "Day of the Week"
  ) + theme_classic() +
  theme(plot.subtitle = element_text(hjust = 0.5))
```

```{r seasonality_plot}
season_df %>% filter(crime_group == "Weapon-Related") %>% 
  group_by(day, hour) %>% 
  summarize(number = n()) %>% 
  ggplot(aes(x = as.factor(hour), y = day)) +
  geom_tile(aes(fill = number), colour = "white") +
  scale_fill_gradient(low = "#fde0dd", high = "#c51b8a") +
  labs(
    title = "Day of the Week on Weapon-Related crime activity",
    x = "Hour of day",
    y = "Day of the Week"
  ) + theme_classic() +
  theme(plot.subtitle = element_text(hjust = 0.5))
```

The pictures of Weapon-Related and Drug related have similar color patterns which suggests these crimes are taking place together or around the same time. Surprisingly, Mondays and Tuesdays are quiet days for Drug related and Weapon related felony crimes. 
We see that overwhelming majority of the sex crimes occurs at midnight on all days. 

#### Victim race 

```{r seasonality_race}
season_df %>% 
  group_by(vic_sex) %>% summarize(number = n())

season_df %>% filter(vic_race != "unknown") %>% 
  group_by(vic_race, boro_nm) %>% summarize(number = n()) %>% 
  ggplot(aes(x = vic_race, y = number, fill = vic_race)) + geom_col() + facet_wrap(~boro_nm) + 
  theme(axis.text.x = element_text(angle = 80, hjust = 1, size = 8))
  
```





